<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Auth Diagnostic</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #333;
        }

        h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #555;
            border-bottom: 2px solid #007aff;
            padding-bottom: 8px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-right: 8px;
        }

        .status.success {
            background: #34c759;
            color: white;
        }

        .status.error {
            background: #ff3b30;
            color: white;
        }

        .status.warning {
            background: #ff9500;
            color: white;
        }

        .status.info {
            background: #007aff;
            color: white;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
            font-family: 'Courier New', monospace;
            direction: ltr;
            text-align: left;
        }

        button {
            background: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
        }

        .log-line {
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-warning { color: #dcdcaa; }
        .log-info { color: #9cdcfe; }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ” ××‘×—×•×Ÿ ××™××•×ª Telegram</h1>
            <p style="color: #666; margin-top: 8px;">×›×œ×™ ×–×” ×‘×•×“×§ ××ª ×ª×”×œ×™×š ×”××™××•×ª ×•××–×”×” ×‘×¢×™×•×ª</p>
        </div>

        <div class="card">
            <h2>ğŸ“± ×¡×˜×˜×•×¡ Telegram Mini App</h2>
            <div id="telegram-status"></div>
        </div>

        <div class="card">
            <h2>ğŸ” ×‘×“×™×§×ª Edge Function</h2>
            <div id="edge-function-status"></div>
            <button id="test-btn" onclick="testAuthentication()">×‘×“×•×§ ××™××•×ª</button>
        </div>

        <div class="card">
            <h2>ğŸ“‹ ×œ×•×’ ××¤×•×¨×˜</h2>
            <div id="log" class="log"></div>
        </div>

        <div class="card">
            <h2>ğŸ’¡ ×”××œ×¦×•×ª</h2>
            <div id="recommendations"></div>
        </div>
    </div>

    <script>
        const logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            logs.push({ timestamp, message, type });
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = logs.map(l =>
                `<div class="log-line log-${l.type}">[${l.timestamp}] ${l.message}</div>`
            ).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function checkTelegramStatus() {
            const statusDiv = document.getElementById('telegram-status');
            const WebApp = window.Telegram?.WebApp;

            if (!WebApp) {
                statusDiv.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">×¡×˜×˜×•×¡</span>
                        <span><span class="status error">âŒ ×œ× ×–××™×Ÿ</span></span>
                    </div>
                    <p style="color: #ff3b30; margin-top: 12px;">
                        ××¤×œ×™×§×¦×™×” ×–×• ×—×™×™×‘×ª ×œ×”×™×¤×ª×— ××ª×•×š Telegram Mini App
                    </p>
                `;
                log('Telegram SDK ×œ× ×–××™×Ÿ - ×™×© ×œ×¤×ª×•×— ××ª×•×š Telegram', 'error');
                return false;
            }

            const hasInitData = !!WebApp.initData;
            const user = WebApp.initDataUnsafe?.user;

            statusDiv.innerHTML = `
                <div class="info-row">
                    <span class="info-label">×¡×˜×˜×•×¡</span>
                    <span><span class="status success">âœ… ×–××™×Ÿ</span></span>
                </div>
                <div class="info-row">
                    <span class="info-label">×’×¨×¡×”</span>
                    <span class="info-value">${WebApp.version}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">×¤×œ×˜×¤×•×¨××”</span>
                    <span class="info-value">${WebApp.platform}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">initData</span>
                    <span><span class="status ${hasInitData ? 'success' : 'error'}">${hasInitData ? 'âœ… ×§×™×™×' : 'âŒ ×—×¡×¨'}</span></span>
                </div>
                <div class="info-row">
                    <span class="info-label">××•×¨×š initData</span>
                    <span class="info-value">${WebApp.initData?.length || 0} ×ª×•×•×™×</span>
                </div>
                ${user ? `
                <div class="info-row">
                    <span class="info-label">××©×ª××© ID</span>
                    <span class="info-value">${user.id}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">×©× ××©×ª××©</span>
                    <span class="info-value">${user.username || '(×œ×œ×)'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">×©×</span>
                    <span class="info-value">${user.first_name} ${user.last_name || ''}</span>
                </div>
                ` : ''}
            `;

            log(`Telegram SDK ×–××™×Ÿ - ×’×¨×¡×” ${WebApp.version}`, 'success');
            if (hasInitData) {
                log(`initData ×§×™×™× (${WebApp.initData.length} ×ª×•×•×™×)`, 'success');
            } else {
                log('initData ×—×¡×¨ - ×–×” ×‘×¢×™×™×ª×™!', 'error');
            }

            if (user) {
                log(`××©×ª××©: ${user.first_name} (ID: ${user.id})`, 'info');
            }

            return hasInitData;
        }

        async function testAuthentication() {
            const btn = document.getElementById('test-btn');
            const statusDiv = document.getElementById('edge-function-status');
            const recommendationsDiv = document.getElementById('recommendations');

            btn.disabled = true;
            btn.innerHTML = '×‘×•×“×§... <div class="spinner"></div>';

            log('××ª×—×™×œ ×‘×“×™×§×ª ××™××•×ª', 'info');

            const WebApp = window.Telegram?.WebApp;
            if (!WebApp?.initData) {
                statusDiv.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">×¡×˜×˜×•×¡</span>
                        <span><span class="status error">âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§</span></span>
                    </div>
                    <p style="color: #ff3b30; margin-top: 12px;">
                        ××™×Ÿ initData - ×™×© ×œ×¤×ª×•×— ××ª×•×š Telegram
                    </p>
                `;
                log('×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ - ××™×Ÿ initData', 'error');
                btn.disabled = false;
                btn.innerHTML = '×‘×“×•×§ ××™××•×ª';
                return;
            }

            // Get Supabase URL from meta tag or prompt
            let supabaseUrl = document.querySelector('meta[name="supabase-url"]')?.content;
            if (!supabaseUrl) {
                supabaseUrl = prompt('×”×–×Ÿ ××ª ×”-Supabase URL ×©×œ×š:', 'https://your-project.supabase.co');
            }

            if (!supabaseUrl) {
                log('×œ× ×”×•×–×Ÿ Supabase URL', 'error');
                btn.disabled = false;
                btn.innerHTML = '×‘×“×•×§ ××™××•×ª';
                return;
            }

            const url = `${supabaseUrl}/functions/v1/telegram-verify`;
            log(`×©×•×œ×— ×‘×§×©×” ×œ: ${url}`, 'info');

            try {
                const startTime = Date.now();
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'webapp',
                        initData: WebApp.initData
                    })
                });
                const duration = Date.now() - startTime;

                log(`×ª×’×•×‘×” ×”×ª×§×‘×œ×” ×ª×•×š ${duration}ms`, 'info');
                log(`×¡×˜×˜×•×¡: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                const result = await response.json();
                log(`×ª×•×›×Ÿ ×”×ª×’×•×‘×”: ${JSON.stringify(result, null, 2)}`, 'info');

                if (response.status === 200 && result.ok) {
                    statusDiv.innerHTML = `
                        <div class="info-row">
                            <span class="info-label">×¡×˜×˜×•×¡</span>
                            <span><span class="status success">âœ… ××™××•×ª ×”×¦×œ×™×—!</span></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">×–××Ÿ ×ª×’×•×‘×”</span>
                            <span class="info-value">${duration}ms</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">××©×ª××© ID</span>
                            <span class="info-value">${result.user?.id || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">×ª×¤×§×™×“</span>
                            <span class="info-value">${result.user?.role || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Session</span>
                            <span><span class="status success">âœ… ×§×™×™×</span></span>
                        </div>
                    `;

                    recommendationsDiv.innerHTML = `
                        <p style="color: #34c759; font-weight: 600; margin-bottom: 8px;">
                            âœ… ×”××™××•×ª ×¢×•×‘×“ ×‘×¦×•×¨×” ××•×©×œ××ª!
                        </p>
                        <p style="color: #666;">
                            ××™×Ÿ ×¦×•×¨×š ×‘×©×™× ×•×™×™×. ×”××¤×œ×™×§×¦×™×” ×××•×¨×” ×œ×¢×‘×•×“ ×œ×œ× ×‘×¢×™×•×ª.
                        </p>
                    `;

                    log('âœ… ××™××•×ª ×”×¦×œ×™×—! ×”××©×ª××© ××•××ª ×‘×”×¦×œ×—×”', 'success');

                } else if (response.status === 401) {
                    statusDiv.innerHTML = `
                        <div class="info-row">
                            <span class="info-label">×¡×˜×˜×•×¡</span>
                            <span><span class="status error">âŒ ××™××•×ª × ×›×©×œ - 401</span></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">×©×’×™××”</span>
                            <span class="info-value">${result.error || 'Invalid signature'}</span>
                        </div>
                    `;

                    recommendationsDiv.innerHTML = `
                        <p style="color: #ff3b30; font-weight: 600; margin-bottom: 12px;">
                            âŒ ×©×’×™××ª ××™××•×ª - HMAC signature ×œ× ×ª×•××
                        </p>
                        <p style="margin-bottom: 8px; font-weight: 600;">×”×¡×™×‘×•×ª ×”××¤×©×¨×™×•×ª:</p>
                        <ol style="margin-right: 20px; line-height: 1.8; color: #666;">
                            <li><strong>TELEGRAM_BOT_TOKEN ×©×’×•×™:</strong> ×”×˜×•×§×Ÿ ×‘-Supabase ×œ× ×ª×•×× ××ª ×”×‘×•×˜ ×©×¤×ª×— ××ª ×”××™× ×™-××¤</li>
                            <li><strong>×”×˜×•×§×Ÿ ×—×¡×¨:</strong> ×”××©×ª× ×” TELEGRAM_BOT_TOKEN ×œ× ××•×’×“×¨ ×‘-Supabase</li>
                            <li><strong>×‘×•×˜×™× ××¨×•×‘×™×:</strong> ×™×© ×œ×š ×›××” ×‘×•×˜×™× ×•×”×˜×•×§×Ÿ ××¢×•×¨×‘×‘</li>
                            <li><strong>Edge Function ×œ× ×¢×•×“×›×Ÿ:</strong> ×™×© ×œ×”×¤×¢×™×œ ××—×“×© ××ª telegram-verify</li>
                        </ol>
                        <p style="margin-top: 12px; font-weight: 600;">×¤×ª×¨×•×Ÿ:</p>
                        <ol style="margin-right: 20px; line-height: 1.8; color: #666;">
                            <li>×¤×ª×— ××ª @BotFather ×‘-Telegram</li>
                            <li>×©×œ×— /mybots ×•×‘×—×¨ ××ª ×”×‘×•×˜ <strong>×©×¤×ª×— ××ª ×”××™× ×™-××¤ ×”×–×”</strong></li>
                            <li>×œ×—×¥ ×¢×œ "API Token" ×•×”×¢×ª×§ ××ª ×”×˜×•×§×Ÿ ×”××œ×</li>
                            <li>×œ×š ×œ-Supabase Dashboard â†’ Edge Functions â†’ Configuration</li>
                            <li>×”×•×¡×£/×¢×“×›×Ÿ ××ª TELEGRAM_BOT_TOKEN ×¢× ×”×˜×•×§×Ÿ ×”×—×“×©</li>
                            <li>×”×¤×¢×œ ××—×“×© ××ª telegram-verify edge function</li>
                        </ol>
                    `;

                    log('âŒ ××™××•×ª × ×›×©×œ - signature ×œ× ×ª×•××', 'error');
                    log('×–×” ××•××¨ ×©-TELEGRAM_BOT_TOKEN ×©×’×•×™ ××• ×—×¡×¨', 'warning');

                } else if (response.status === 404) {
                    statusDiv.innerHTML = `
                        <div class="info-row">
                            <span class="info-label">×¡×˜×˜×•×¡</span>
                            <span><span class="status error">âŒ Edge Function ×œ× × ××¦×</span></span>
                        </div>
                    `;

                    recommendationsDiv.innerHTML = `
                        <p style="color: #ff3b30; font-weight: 600; margin-bottom: 12px;">
                            âŒ telegram-verify edge function ×œ× × ××¦×
                        </p>
                        <p style="margin-bottom: 8px;">×™×© ×œ×”×¢×œ×•×ª ××ª ×”-edge function:</p>
                        <ol style="margin-right: 20px; line-height: 1.8; color: #666;">
                            <li>×”×ª×§×Ÿ ××ª Supabase CLI: <code>npm install -g supabase</code></li>
                            <li>×”×ª×—×‘×¨: <code>supabase login</code></li>
                            <li>×”×¢×œ×”: <code>supabase functions deploy telegram-verify</code></li>
                        </ol>
                        <p style="margin-top: 12px; color: #666;">
                            ××• ×”×¢×œ×” ×“×¨×š Supabase Dashboard ×‘×××©×§ ×”×’×¨×¤×™
                        </p>
                    `;

                    log('âŒ Edge function ×œ× × ××¦× - ×¦×¨×™×š ×œ×”×¢×œ×•×ª ××•×ª×•', 'error');

                } else {
                    statusDiv.innerHTML = `
                        <div class="info-row">
                            <span class="info-label">×¡×˜×˜×•×¡</span>
                            <span><span class="status error">âŒ ×©×’×™××” ×œ× ×¦×¤×•×™×”</span></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">×§×•×“ ×©×’×™××”</span>
                            <span class="info-value">${response.status}</span>
                        </div>
                    `;

                    recommendationsDiv.innerHTML = `
                        <p style="color: #ff9500; font-weight: 600; margin-bottom: 12px;">
                            âš ï¸ ×©×’×™××” ×œ× ×¦×¤×•×™×” (${response.status})
                        </p>
                        <p style="color: #666;">
                            ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×©×œ telegram-verify edge function ×‘-Supabase Dashboard
                        </p>
                    `;

                    log(`×©×’×™××” ×œ× ×¦×¤×•×™×”: ${response.status}`, 'error');
                }

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">×¡×˜×˜×•×¡</span>
                        <span><span class="status error">âŒ ×—×¨×™×’</span></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">×©×’×™××”</span>
                        <span class="info-value">${error.message}</span>
                    </div>
                `;

                recommendationsDiv.innerHTML = `
                    <p style="color: #ff3b30; font-weight: 600; margin-bottom: 12px;">
                        ğŸ’¥ ×©×’×™××ª ×¨×©×ª ××• ×—×¨×™×’
                    </p>
                    <p style="color: #666; margin-bottom: 8px;">
                        ×‘×“×•×§ ××ª:
                    </p>
                    <ul style="margin-right: 20px; line-height: 1.8; color: #666;">
                        <li>×”-Supabase URL × ×›×•×Ÿ</li>
                        <li>×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×¤×¢×™×œ</li>
                        <li>CORS ××•×’×“×¨ × ×›×•×Ÿ ×‘-edge function</li>
                    </ul>
                `;

                log(`ğŸ’¥ ×—×¨×™×’: ${error.message}`, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '×‘×“×•×§ ×©×•×‘';
        }

        // Initialize
        window.addEventListener('load', () => {
            log('×›×œ×™ ×”××‘×—×•×Ÿ × ×˜×¢×Ÿ', 'success');
            checkTelegramStatus();
        });
    </script>
</body>
</html>
