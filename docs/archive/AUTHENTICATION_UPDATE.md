# Authentication System Update - JWT Secret Removed

## Summary

The authentication system has been successfully refactored to work with Bolt's managed Supabase database without requiring the `SUPABASE_JWT_SECRET` environment variable.

## What Changed

### 1. Edge Function Refactor (`supabase/functions/telegram-verify/index.ts`)

**Before:**
- Manually signed JWT tokens using the `jose` library and `SUPABASE_JWT_SECRET`
- Required access to Supabase's internal JWT signing key
- Not compatible with Bolt's managed database (secret not exposed)

**After:**
- Uses Supabase Auth Admin API (`supabase.auth.admin`)
- Creates authentic Supabase sessions with built-in security
- Stores custom claims in `app_metadata` instead of top-level JWT payload
- Compatible with all Supabase deployments including Bolt's managed database

### 2. Authentication Flow

**New Process:**
1. Telegram user authenticates via WebApp initData
2. HMAC signature is verified against `TELEGRAM_BOT_TOKEN`
3. User record is created/updated in custom `users` table
4. Auth user is created/updated in `auth.users` via Admin API
5. Custom claims stored in `user_metadata` and `app_metadata`
6. Session token generated by Supabase (secure, native)
7. Frontend receives session token and sets it using `supabase.auth.setSession()`

### 3. Custom Claims Storage

Custom claims are now stored in Supabase's standard metadata fields:

**app_metadata** (server-controlled, not user-editable):
- `provider: 'telegram'`
- `role: string` (user/dispatcher/courier/etc)
- `workspace_id: string | null`
- `user_id: string` (custom users table ID)
- `telegram_id: string`
- `user_role: string`

**user_metadata** (user profile data):
- `telegram_id: string`
- `username: string`
- `name: string`
- `photo_url: string`

### 4. Environment Variables

**Removed:**
- `SUPABASE_JWT_SECRET` (no longer needed)

**Required for Edge Functions:**
- `SUPABASE_URL` ✅
- `SUPABASE_SERVICE_ROLE_KEY` ✅
- `TELEGRAM_BOT_TOKEN` ✅
- `TELEGRAM_WEBHOOK_SECRET` ✅

**Required for Frontend:**
- `VITE_SUPABASE_URL` ✅
- `VITE_SUPABASE_ANON_KEY` ✅

## Benefits

1. **Works with Bolt Database** - No longer requires access to JWT secret
2. **More Secure** - Uses Supabase's native session generation
3. **Better Compatibility** - Works with all Supabase deployment models
4. **Simpler Setup** - One less secret to manage
5. **Standard Approach** - Follows Supabase best practices

## Migration Notes

### For Existing Deployments

No migration is needed for existing users! The new system:
- Creates new `auth.users` entries automatically on next login
- Maintains existing custom `users` table records
- Links auth users to custom users via metadata
- Previous sessions will expire naturally, new sessions use native auth

### RLS Policies

If your RLS policies reference custom JWT claims, update them to use:

```sql
-- Old approach (manual JWT claims)
auth.jwt() ->> 'user_id'
auth.jwt() ->> 'telegram_id'

-- New approach (app_metadata)
(auth.jwt() -> 'app_metadata' ->> 'user_id')
(auth.jwt() -> 'app_metadata' ->> 'telegram_id')
(auth.jwt() -> 'app_metadata' ->> 'role')
(auth.jwt() -> 'app_metadata' ->> 'workspace_id')
```

### Frontend Code

The frontend authentication code (`src/lib/twaAuth.ts`) requires minimal changes:
- Session tokens now come from Supabase Auth API
- Claims are accessible via `session.user.app_metadata`
- Existing session handling continues to work

## Testing

### Build Status
✅ Frontend builds successfully without errors
✅ No JWT_SECRET references remain in code
✅ Environment variables properly configured

### Next Steps for Full Testing

1. Deploy updated Edge Function to Supabase
2. Test Telegram authentication flow end-to-end
3. Verify custom claims appear in session
4. Confirm RLS policies work with app_metadata approach
5. Test role-based access control
6. Verify workspace isolation

## Technical Details

### Auth User Email Format

Since Telegram users don't have email addresses, the system generates:
```
telegram_<telegram_id>@telegram-auth.local
```

Example: `telegram_123456789@telegram-auth.local`

This ensures:
- Unique identifier for each Telegram user
- Compatible with Supabase's email-based auth system
- Not a real email (won't receive messages)

### Session Token Structure

Supabase-generated tokens include:
- Standard JWT claims (`iss`, `sub`, `aud`, `exp`, `iat`)
- User metadata in `user_metadata` field
- App metadata in `app_metadata` field (our custom claims)
- Proper signature using Supabase's internal key
- Automatic refresh token support

## Troubleshooting

### "Missing Supabase configuration" Error

**Cause:** Edge Function can't find required environment variables

**Solution:**
```bash
# For Bolt managed database - these should be automatic
# For self-hosted, set via Supabase CLI:
supabase secrets set TELEGRAM_BOT_TOKEN=your_token
supabase secrets set TELEGRAM_WEBHOOK_SECRET=your_secret
```

### Session Creation Fails

**Cause:** Service role key may not have admin permissions

**Solution:**
- Verify `SUPABASE_SERVICE_ROLE_KEY` is correct
- Check it has `service_role` permissions
- Ensure it's not the anon key by mistake

### Claims Not Appearing in Frontend

**Cause:** Reading from old JWT structure

**Solution:**
Update frontend code to read from `app_metadata`:
```typescript
// Old
const userId = session.user_id;

// New
const userId = session.user.app_metadata.user_id;
```

## Support

For issues or questions about this authentication system:
1. Check Edge Function logs in Supabase Dashboard
2. Verify environment variables are set
3. Test Telegram signature verification separately
4. Review `src/lib/twaAuth.ts` for frontend flow

## References

- [Supabase Auth Admin API](https://supabase.com/docs/reference/javascript/auth-admin-createuser)
- [Supabase JWT Structure](https://supabase.com/docs/guides/auth/jwts)
- [Telegram WebApp Authentication](https://core.telegram.org/bots/webapps#validating-data-received-via-the-mini-app)
