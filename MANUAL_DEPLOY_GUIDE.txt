╔══════════════════════════════════════════════════════════════════════╗
║                  TELEGRAM AUTH FIX - DEPLOY GUIDE                    ║
║                         (5 Minute Fix)                               ║
╔══════════════════════════════════════════════════════════════════════╗

🎯 GOAL: Deploy telegram-verify function to stop authentication loop

📍 YOUR PROJECT: https://supabase.com/dashboard/project/ncuyyjvvzeaqqjganbzz

═══════════════════════════════════════════════════════════════════════

STEP 1: Open Supabase Dashboard
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. Click: https://supabase.com/dashboard/project/ncuyyjvvzeaqqjganbzz/functions
2. You should see "Edge Functions" page

═══════════════════════════════════════════════════════════════════════

STEP 2: Deploy telegram-verify Function
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

A) If function exists:
   - Click on "telegram-verify"
   - Click "Edit" or look for code editor
   - Select all existing code
   - Delete it

B) If function doesn't exist:
   - Click "New Function"
   - Name: telegram-verify
   - Click "Create"

C) Copy the code:
   - Open: supabase/functions/telegram-verify/index.ts
   - Select all (Ctrl+A or Cmd+A)
   - Copy (Ctrl+C or Cmd+C)
   
D) Paste into dashboard:
   - Click in the code editor
   - Paste (Ctrl+V or Cmd+V)
   - Code should be 216 lines

E) Deploy:
   - Click "Deploy" button (usually bottom-right)
   - Wait 10-30 seconds for deployment
   - Status should change to "Deployed" ✅

═══════════════════════════════════════════════════════════════════════

STEP 3: Verify Environment Secrets
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. Click: https://supabase.com/dashboard/project/ncuyyjvvzeaqqjganbzz/settings/functions
2. Look for "Secrets" section
3. Verify these exist (you already confirmed they do):
   ✅ TELEGRAM_BOT_TOKEN
   ✅ SUPABASE_SERVICE_ROLE_KEY
   ✅ SUPABASE_URL

═══════════════════════════════════════════════════════════════════════

STEP 4: Test the Deployment
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

In terminal, run:

curl -X POST https://ncuyyjvvzeaqqjganbzz.supabase.co/functions/v1/telegram-verify \
  -H "Content-Type: application/json" \
  -d '{"test": true}'

EXPECTED RESULT:
{"ok":false,"error":"Missing initData"}

✅ This is GOOD! Means function is deployed and running.
❌ If you get 404: Function not deployed correctly
❌ If you get CORS error: That's okay for curl test

═══════════════════════════════════════════════════════════════════════

STEP 5: Test in Telegram App
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. Open Telegram (mobile or desktop)
2. Find your mini app bot
3. Click to open the app
4. Watch for:
   - NO MORE "Invalid login credentials" loop
   - Should authenticate instantly
   - Should show dashboard/home screen

If using Telegram Desktop/Web:
- Open browser DevTools (F12)
- Console should show:
  ✅ "✅ Authentication successful"
  ✅ "✅ Session established successfully"

═══════════════════════════════════════════════════════════════════════

STEP 6: Check Logs (Optional but Recommended)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. Go to: Edge Functions → telegram-verify → Logs
2. Open your app in Telegram
3. You should see in logs:
   - "✅ Telegram user verified: [username]"
   - "🔄 Sign-in attempt 1/3..."
   - "✅ Sign-in successful on attempt 1"
   - "✅ Session created successfully"

═══════════════════════════════════════════════════════════════════════

🎉 SUCCESS INDICATORS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ No more authentication loop
✅ App loads dashboard instantly
✅ No "Invalid login credentials" errors
✅ New users get created in database
✅ Logs show successful authentication

═══════════════════════════════════════════════════════════════════════

❌ TROUBLESHOOTING
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Problem: Still getting "Invalid login credentials"
Solution: 
  1. Check SUPABASE_SERVICE_ROLE_KEY is set in secrets
  2. Redeploy the function
  3. Clear Telegram app cache
  4. Try again

Problem: Function shows deployed but not working
Solution:
  1. Check logs for errors
  2. Verify all 216 lines were copied
  3. Try redeploying
  4. Check endpoint URL in frontend code

Problem: "TELEGRAM_BOT_TOKEN not configured"
Solution:
  1. Go to Settings → Edge Functions → Secrets
  2. Add TELEGRAM_BOT_TOKEN with your bot token
  3. Redeploy function

═══════════════════════════════════════════════════════════════════════

⏱️ ESTIMATED TIME
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Dashboard access:        30 seconds
Copy/paste code:         1 minute
Deploy function:         30 seconds
Verify deployment:       1 minute
Test in Telegram:        2 minutes
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TOTAL:                   ~5 minutes

═══════════════════════════════════════════════════════════════════════

📚 ADDITIONAL RESOURCES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- Full guide: DEPLOY_EDGE_FUNCTIONS.md
- Code reference: FUNCTION_CODE_REFERENCE.md
- Original function: supabase/functions/telegram-verify/index.ts

═══════════════════════════════════════════════════════════════════════

🚀 NEXT STEPS AFTER SUCCESS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. ✅ Test with multiple users
2. ✅ Deploy other functions when convenient (optional)
3. ✅ Remove PINEntry fallback (no longer needed)
4. ✅ Monitor logs for any issues
5. ✅ Celebrate working authentication! 🎊

═══════════════════════════════════════════════════════════════════════
